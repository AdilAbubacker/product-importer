<!DOCTYPE html>
<html>
<head>
    <title>Products</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background: #eee; }
        input, button, select { padding: 5px; margin-right: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 400px; border-radius: 5px; }
        .modal-header { font-weight: bold; margin-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group textarea { width: 100%; padding: 5px; }
        .form-group textarea { height: 60px; }
        .form-actions { text-align: right; margin-top: 15px; }
        .form-actions button { margin-left: 10px; }
    </style>
</head>

<body>

<h2>Products</h2>

<div>
    <input type="text" id="search" placeholder="Search SKU or Name" onkeyup="if(event.key==='Enter') loadProducts()">
    <select id="active-filter">
        <option value="">All</option>
        <option value="true">Active</option>
        <option value="false">Inactive</option>
    </select>
    <button onclick="loadProducts()">Search</button>
    <button onclick="showAddModal()">+ Add Product</button>
</div>

<br>

<table id="products-table">
    <thead>
        <tr>
            <th>#</th>
            <th>SKU</th>
            <th>Name</th>
            <th>Description</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="pagination"></div>

<!-- Add/Edit Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">Add Product</div>
        <form id="productForm">
            <input type="hidden" id="productId" value="">
            <div class="form-group">
                <label id="skuLabel">SKU *</label>
                <input type="text" id="sku" required>
                <small id="skuHelp" style="display:none; color:#666; font-style:italic;">SKU cannot be changed after creation</small>
            </div>
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="description"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="active" checked> Active
                </label>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeModal()">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
let page = 1;

function getCsrfToken() {
    // Get CSRF token from cookies
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadProducts() {
    const search = document.getElementById("search").value;
    const active = document.getElementById("active-filter").value;

    let url = `/api/products/?page=${page}`;

    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (active) url += `&active=${active}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            if (data.results) {
                renderTable(data.results);
                renderPagination(data.next, data.previous);
            } else {
                console.error("Unexpected response format:", data);
            }
        })
        .catch(err => {
            console.error("Error loading products:", err);
            alert("Error loading products. Check console for details.");
        });
}

function renderTable(products) {
    const tbody = document.querySelector("#products-table tbody");
    tbody.innerHTML = "";

    if (!products || products.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No products found</td></tr>`;
        return;
    }

    products.forEach((p, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${(page - 1) * 50 + i + 1}</td>
                <td>${p.sku || ''}</td>
                <td>${p.name || ''}</td>
                <td>${p.description || ''}</td>
                <td>${p.active ? 'Yes' : 'No'}</td>
                <td>
                    <button onclick="editProduct(${p.id})">Edit</button>
                    <button onclick="deleteProduct(${p.id})">Delete</button>
                </td>
            </tr>
        `;
    });
}

function renderPagination(next, previous) {
    let html = "";

    if (previous) {
        html += `<button onclick="page--; loadProducts()">Prev</button>`;
    }

    if (next) {
        html += `<button onclick="page++; loadProducts()">Next</button>`;
    }

    document.getElementById("pagination").innerHTML = html;
}

function showAddModal() {
    document.getElementById("modalTitle").textContent = "Add Product";
    document.getElementById("productId").value = "";
    document.getElementById("productForm").reset();
    document.getElementById("active").checked = true;
    // Enable SKU field for new products
    const skuInput = document.getElementById("sku");
    const skuLabel = document.getElementById("skuLabel");
    const skuHelp = document.getElementById("skuHelp");
    skuInput.disabled = false;
    skuInput.style.backgroundColor = "";
    skuInput.style.cursor = "";
    skuInput.required = true;
    skuLabel.textContent = "SKU *";
    skuHelp.style.display = "none";
    document.getElementById("productModal").style.display = "block";
}

function editProduct(id) {
    fetch(`/api/products/${id}/`)
        .then(res => res.json())
        .then(product => {
            document.getElementById("modalTitle").textContent = "Edit Product";
            document.getElementById("productId").value = product.id;
            const skuInput = document.getElementById("sku");
            const skuLabel = document.getElementById("skuLabel");
            const skuHelp = document.getElementById("skuHelp");
            skuInput.value = product.sku || "";
            // Disable SKU field when editing (read-only)
            skuInput.disabled = true;
            skuInput.style.backgroundColor = "#f5f5f5";
            skuInput.style.cursor = "not-allowed";
            skuInput.required = false;
            skuLabel.textContent = "SKU (Read-only)";
            skuHelp.style.display = "block";
            document.getElementById("name").value = product.name || "";
            document.getElementById("description").value = product.description || "";
            document.getElementById("active").checked = product.active !== false;
            document.getElementById("productModal").style.display = "block";
        })
        .catch(err => {
            console.error("Error loading product:", err);
            alert("Error loading product details.");
        });
}

function closeModal() {
    document.getElementById("productModal").style.display = "none";
    // Reset SKU field state when closing modal
    const skuInput = document.getElementById("sku");
    const skuLabel = document.getElementById("skuLabel");
    const skuHelp = document.getElementById("skuHelp");
    skuInput.disabled = false;
    skuInput.style.backgroundColor = "";
    skuInput.style.cursor = "";
    skuInput.required = true;
    skuLabel.textContent = "SKU *";
    skuHelp.style.display = "none";
}

function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;

    fetch(`/api/products/${id}/`, {
        method: "DELETE",
        headers: {
            "X-CSRFToken": getCsrfToken(),
            "Content-Type": "application/json"
        },
        credentials: "same-origin"
    })
    .then(res => {
        if (res.ok) {
            loadProducts();
        } else {
            alert("Error deleting product.");
        }
    })
    .catch(err => {
        console.error("Error deleting product:", err);
        alert("Error deleting product.");
    });
}

// Handle form submission
document.getElementById("productForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const id = document.getElementById("productId").value;
    const productData = {
        sku: document.getElementById("sku").value,
        name: document.getElementById("name").value,
        description: document.getElementById("description").value,
        active: document.getElementById("active").checked
    };

    const url = id ? `/api/products/${id}/` : `/api/products/`;
    const method = id ? "PUT" : "POST";

    fetch(url, {
        method: method,
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken()
        },
        credentials: "same-origin",
        body: JSON.stringify(productData)
    })
    .then(res => res.json())
    .then(data => {
        closeModal();
        loadProducts();
    })
    .catch(err => {
        console.error("Error saving product:", err);
        alert("Error saving product. Check console for details.");
    });
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById("productModal");
    if (event.target == modal) {
        closeModal();
    }
}

// Load products on page load
loadProducts();
</script>

</body>
</html>
