<!DOCTYPE html>
<html>
<head>
    <title>Products</title>

    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
        }

        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 10px;
        }

        th, td { 
            border: 1px solid #ccc; 
            padding: 8px; 
        }

        th { 
            background: #eee; 
        }

        input, button, select { 
            padding: 6px; 
            margin-right: 8px; 
        }

        #pagination { 
            margin-top: 12px; 
        }

        #pagination button { 
            padding: 6px 10px; 
        }
    </style>
</head>

<body>

<h2>Product List</h2>

<div>
    <input type="text" id="search" placeholder="Search SKU or Name">

    <select id="active-filter">
        <option value="">All</option>
        <option value="true">Active</option>
        <option value="false">Inactive</option>
    </select>

    <button onclick="resetPageAndLoad()">Search</button>

    <button onclick="window.location='/api/product-form/'">
        + Add Product
    </button>

    <button onclick="bulkDelete()">Delete Selected</button>
</div>

<table id="products-table">
    <thead>
        <tr>
            <th><input type="checkbox" onclick="toggleAll(this)"></th>
            <th>ID</th>
            <th>SKU</th>
            <th>Name</th>
            <th>Description</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="pagination"></div>

<script>
// =============================
// CSRF
// =============================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie("csrftoken");

// =============================
// STATE
// =============================
let page = 1;
let selected = new Set();

// =============================
// LOAD PRODUCTS
// =============================
function resetPageAndLoad() {
    page = 1;
    loadProducts();
}

function loadProducts() {
    const search = document.getElementById("search").value;
    const active = document.getElementById("active-filter").value;

    let url = `/api/products/?page=${page}`;

    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (active) url += `&active=${encodeURIComponent(active)}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            renderTable(data.results || []);
            renderPagination(data.next, data.previous);
        })
        .catch(err => console.error("Error loading products:", err));
}

// =============================
// RENDER TABLE
// =============================
function renderTable(products) {
    const tbody = document.querySelector("#products-table tbody");
    tbody.innerHTML = "";

    products.forEach((p, i) => {
        const checked = selected.has(p.id) ? "checked" : "";

        tbody.innerHTML += `
            <tr>
                <td><input type="checkbox" onclick="toggleOne(${p.id})" ${checked}></td>
                <td>${p.id}</td>
                <td>${p.sku}</td>
                <td>${p.name}</td>
                <td>${p.description || ""}</td>
                <td>${p.active ? "Yes" : "No"}</td>
                <td>
                    <button onclick="editProduct(${p.id})">Edit</button>
                    <button onclick="deleteProduct(${p.id})">Delete</button>
                </td>
            </tr>
        `;
    });
}

// =============================
// PAGINATION
// =============================
function renderPagination(next, previous) {
    let html = "";

    if (previous) {
        html += `<button onclick="page--; loadProducts()">Prev</button>`;
    }

    if (next) {
        html += `<button onclick="page++; loadProducts()">Next</button>`;
    }

    document.getElementById("pagination").innerHTML = html;
}

// =============================
// CHECKBOX LOGIC
// =============================
function toggleOne(id) {
    if (selected.has(id)) selected.delete(id);
    else selected.add(id);
}

function toggleAll(master) {
    const rows = document.querySelectorAll("#products-table tbody tr");
    selected.clear();

    rows.forEach(row => {
        const checkbox = row.querySelector("input[type='checkbox']");
        checkbox.checked = master.checked;
        const id = parseInt(row.children[1].innerText);
        if (master.checked) selected.add(id);
    });
}

// =============================
// SINGLE DELETE
// =============================
function deleteProduct(id) {
    if (!confirm("Delete this product?")) return;

    fetch(`/api/products/${id}/`, {
        method: "DELETE",
        headers: {
            "X-CSRFToken": csrftoken
        }
    })
    .then(res => {
        if (res.ok) {
            loadProducts();
        } else {
            console.error("Failed to delete", res.status);
        }
    });
}

// =============================
// BULK DELETE
// =============================
function bulkDelete() {
    if (selected.size === 0) {
        alert("No products selected");
        return;
    }

    if (!confirm(`Delete ${selected.size} products?`)) return;

    fetch("/api/products/bulk-delete/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify({ ids: Array.from(selected) })
    })
    .then(res => res.json())
    .then(data => {
        alert(`Deleted ${data.deleted} products`);
        selected.clear();
        loadProducts();
    });
}

// =============================
// EDIT
// =============================
function editProduct(id) {
    window.location = `/api/product-form/?id=${id}`;
}

// =============================
// INITIAL LOAD
// =============================
loadProducts();
</script>

</body>
</html>
