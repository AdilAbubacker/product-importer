<!DOCTYPE html>
<html>
<head>
    <title>Webhooks</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        th {
            background: #eee;
        }

        input, button, select {
            padding: 6px;
            margin-right: 8px;
        }

        #pagination {
            margin-top: 12px;
        }

        #pagination button {
            padding: 6px 10px;
        }
    </style>
</head>

<body>

<h2>Webhooks</h2>

<div>
    <button onclick="openForm()">+ Add Webhook</button>
</div>

<table id="webhooks-table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Event</th>
            <th>Target URL</th>
            <th>Active</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="pagination"></div>

<!-- SIMPLE FORM POPUP -->
<div id="form-container" style="display:none; margin-top:20px; border:1px solid #ccc; padding:20px; width:400px;">
    <h3 id="form-title">Add Webhook</h3>

    <label>Target URL</label>
    <input type="text" id="target_url">

    <label>Event Type</label>
    <select id="event_type">
        <option value="product.updated">Product Updated</option>
    </select>

    <label>Active</label>
    <select id="active">
        <option value="true">Yes</option>
        <option value="false">No</option>
    </select>

    <br>
    <button onclick="saveWebhook()">Save</button>
    <button onclick="closeForm()">Cancel</button>
</div>

<script>
// =============================
// CSRF
// =============================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let c of cookies) {
            c = c.trim();
            if (c.startsWith(name + "=")) {
                cookieValue = c.split("=")[1];
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie("csrftoken");

// =============================
// STATE
// =============================
let page = 1;
let editId = null;

// =============================
// LOAD WEBHOOKS
// =============================
function loadWebhooks() {
    fetch(`/api/webhooks/?page=${page}`)
        .then(res => res.json())
        .then(data => {
            renderTable(data.results || []);
            renderPagination(data.next, data.previous);
        });
}

function renderTable(webhooks) {
    const tbody = document.querySelector("#webhooks-table tbody");
    tbody.innerHTML = "";

    webhooks.forEach(w => {
        tbody.innerHTML += `
            <tr>
                <td>${w.id}</td>
                <td>${w.event_type}</td>
                <td>${w.target_url}</td>
                <td>${w.active ? "Yes" : "No"}</td>
                <td>
                    <button onclick="editWebhook(${w.id})">Edit</button>
                    <button onclick="deleteWebhook(${w.id})">Delete</button>
                    <button onclick="testWebhook(${w.id})">Test</button>
                </td>
            </tr>
        `;
    });
}

// =============================
// PAGINATION
// =============================
function renderPagination(next, previous) {
    let html = "";

    if (previous) {
        html += `<button onclick="page--; loadWebhooks()">Prev</button>`;
    }

    if (next) {
        html += `<button onclick="page++; loadWebhooks()">Next</button>`;
    }

    document.getElementById("pagination").innerHTML = html;
}

// =============================
// FORM HANDLING
// =============================
function openForm() {
    editId = null;
    document.getElementById("form-title").innerText = "Add Webhook";
    document.getElementById("target_url").value = "";
    document.getElementById("active").value = "true";
    document.getElementById("event_type").value = "product.updated";
    document.getElementById("form-container").style.display = "block";
}

function closeForm() {
    document.getElementById("form-container").style.display = "none";
}

function editWebhook(id) {
    editId = id;

    fetch(`/api/webhooks/${id}/`)
        .then(res => res.json())
        .then(w => {
            document.getElementById("form-title").innerText = "Edit Webhook";
            document.getElementById("target_url").value = w.target_url;
            document.getElementById("event_type").value = w.event_type;
            document.getElementById("active").value = w.active ? "true" : "false";
            document.getElementById("form-container").style.display = "block";
        });
}

// =============================
// SAVE (CREATE OR UPDATE)
// =============================
function saveWebhook() {
    const payload = {
        target_url: document.getElementById("target_url").value,
        event_type: document.getElementById("event_type").value,
        active: document.getElementById("active").value === "true",
    };

    const url = editId ? `/api/webhooks/${editId}/` : `/api/webhooks/`;
    const method = editId ? "PATCH" : "POST";

    fetch(url, {
        method: method,
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify(payload),
    })
    .then(res => {
        if (res.ok) {
            closeForm();
            loadWebhooks();
        } else {
            res.json().then(err => console.error("Error:", err));
        }
    });
}

// =============================
// DELETE WEBHOOK
// =============================
function deleteWebhook(id) {
    if (!confirm("Delete this webhook?")) return;

    fetch(`/api/webhooks/${id}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": csrftoken }
    })
    .then(res => {
        if (res.ok) loadWebhooks();
    });
}

// =============================
// TEST WEBHOOK
// =============================
function testWebhook(id) {
    fetch(`/api/webhooks/${id}/test/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken }
    })
    .then(res => res.json())
    .then(data => {
        alert("Test Result: " + JSON.stringify(data));
    });
}

// =============================
// INITIAL LOAD
// =============================
loadWebhooks();
</script>

</body>
</html>
